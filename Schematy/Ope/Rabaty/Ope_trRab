

USE Stacja_Paliw
GO

IF OBJECT_ID('Ope.trRab') IS NOT NULL
DROP TRIGGER Ope.trRab

GO

CREATE TRIGGER Ope.trRab ON Ope.Rabaty AFTER INSERT,UPDATE

AS

IF EXISTS(
SELECT sub.chk, 
COUNT(sub.chk) AS policz
FROM(
SELECT Poziom_Rab,
ID_Paliwa, 
CONCAT(CAST(Poziom_Rab AS varchar),CAST(ID_Paliwa AS varchar)) AS chk FROM Ope.Rabaty) as sub
GROUP BY chk
HAVING  COUNT(chk)>1
) 
BEGIN
PRINT 'Proba wstawienia duplikatu na poziomie rabatu i paliwa'
ROLLBACK TRANSACTION;
RETURN
END;

/* Trigger blokujacy wstawienie drugiego rabatu na tym samym poizomie rabatowym i paliwie*/
