USE Stacja_Paliw;

GO


/* analiza zapasow wg rotacji w razach i dniach liczonych odnoszac wartosc sprzedazy po cenach sprzedazy do wartosci zapasu w cenach zakupu  dla skonczonych okresow rozliczeniowych w latach */

IF OBJECT_ID('Ope.uspAnaliza_Zapasow') IS NOT NULL
DROP PROC Ope.uspAnaliza_Zapasow;

GO

CREATE PROC Ope.uspAnaliza_Zapasow

AS

DECLARE @pierRok int = (SELECT  MIN(DISTINCT Year(CzasTransakcji)) FROM Ope.Dostawy) --od roku w ktorym byla pierwsza dostawa paliwa

DECLARE @dzis date = GETDATE()

/* ostatni rok uwzgledniany w analizie tak by zawsze byl to skonczony rok, nawet gdy dzis jest ostatni dzien w roku to moze sie jeszcze trafic jakas sprzedaz lub dostawa, 
ktora ma wplywa na wyliczenia */

DECLARE @ostaRok int =  YEAR(@dzis)-1   


SELECT  IDPaliwa, YEAR(CzasTransakcji) AS Rok, ROUND(SUM(IloscPaliwa),2) AS Ilosc,CAST( ROUND(SUM(KwotaNetto), 2) AS money) AS Sprzed_Netto  
INTO #sprzedaz
FROM Ope.Sprzedaz
WHERE YEAR(CzasTransakcji) BETWEEN @pierRok AND @ostaRok
GROUP BY IDPaliwa, YEAR(CzasTransakcji)


SELECT IDPaliwa, Rok, SUM(Ilosc) OVER(PARTITION BY IDPaliwa ORDER BY Rok) AS Sprz_ILo_Nar
INTO #sprzeNar
FROM #sprzedaz

/* srednia cena zakupu jako srednia cena za jednsotke danego paliwa w calym roku */

SELECT IDPaliw, Rok, SUM(Ilosc) OVER(PARTITION BY   IDPaliw ORDER BY Rok) AS Zakup_ILo_Nar, Cena_Sr_Zakup
INTO #zakup
FROM(
SELECT  IDPaliw, YEAR(CzasTransakcji) AS Rok, ROUND(SUM(IloscPaliwa), 2) AS Ilosc, CAST( ROUND(SUM(KwotaNetto) / SUM(IloscPaliwa), 2) AS money) AS Cena_Sr_Zakup
FROM Ope.Dostawy 
WHERE YEAR(CzasTransakcji) BETWEEN @pierRok AND @ostaRok
GROUP BY IDPaliw, YEAR(CzasTransakcji) ) AS A


SELECT Z.IDPaliw, Z.Rok, Zakup_ILo_Nar, Sprz_ILo_Nar, Zakup_ILo_Nar - Sprz_ILo_Nar AS Stan_Ilo, Cena_Sr_Zakup, ROUND((Zakup_ILo_Nar - Sprz_ILo_Nar)*Cena_Sr_Zakup,2) AS Zapas_Wart 
INTO #zapasy
FROM #zakup AS Z
JOIN #sprzeNar AS S 
ON Z.IDPaliw=S.IDPaliwa AND Z.Rok=S.Rok


DROP TABLE #sprzeNar
DROP TABLE #zakup


SELECT Rok, CAST(SUM(Zapas_Wart) AS money) AS Wartosc_Zapasu_Koniec
INTO #zapasy_Wart
FROM #zapasy GROUP BY Rok


/* stan zapasu na poczatek okresu n to stan koncowy zapasu na rok n-1 czyli poprzpedni */

DECLARE @zapasy_poczatek table(Rok int, Stan_Poczatek money)

INSERT INTO @zapasy_poczatek(Rok, Stan_Poczatek )
SELECT  MIN(Rok),0
FROM #zapasy_Wart

DECLARE @rok int = (SELECT  MIN(Rok) FROM @zapasy_poczatek)

DECLARE @maxrok int = (SELECT  MAX(Rok) FROM #zapasy_Wart)


WHILE (SELECT ISNULL(MAX(Rok),0) FROM @zapasy_poczatek) <= @maxrok 

BEGIN

INSERT INTO @zapasy_poczatek (Rok, Stan_Poczatek)
SELECT Rok + 1, ISNULL(Wartosc_Zapasu_Koniec, 0)
FROM #zapasy_Wart 
WHERE Rok = @rok 
SET @rok = @rok+1
IF @rok > @maxrok
BREAK
ELSE
CONTINUE
END


SELECT P.Rok, Stan_Poczatek, Wartosc_Zapasu_Koniec, ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec)/2,2) AS Przecietny_Zapas, SUM(S.Sprzed_Netto) AS Sprzed_Netto,

'Rotacji_W_Razach' = CASE WHEN (Stan_Poczatek + Wartosc_Zapasu_Koniec) = 0 THEN 0 ELSE
ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec)/2,2),2) END ,

'Rotacji_W_Dniach' = CASE WHEN (Stan_Poczatek + Wartosc_Zapasu_Koniec) = 0 THEN 0 ELSE
ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) END,

'Interpretacja' = CASE WHEN ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) < 7 
AND ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) <= 360 
THEN 
'Nadmierne zapasy. Firma odnawiala swoje zapasy w ciagu roku ' + CAST(ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) AS nvarchar(10))
+ ' razy/a. ' + 'Gotowka byla zatrzymywana w formie zapasow przez ' + 
CAST(ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) AS nvarchar(10)) + ' dni.'

WHEN ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) < 7 
AND ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) > 360 
THEN 
'Nadmierne zapasy. Firma odnawiala swoje zapasy w ciagu roku ' + CAST(ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) AS nvarchar(10))
+ ' razy/a. ' + 'Gotowka byla zatrzymywana w formie zapasow przez ' + 
CAST(ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) AS nvarchar(10)) + 
' dni. Co stanowi wiecej dni niz ma przyjeta norma dni na rok i wynika z tego, ze przecietna wartosc zapasow byla wieksza niz sprzedaz w danym okresie.'


WHEN ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) BETWEEN 7 AND 10
THEN 
'Optymalny poziom zapasow. Firma odnawiala swoje zapasy w ciagu roku ' + CAST(ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) AS nvarchar(10))
+' razy/a. ' + 'Gotowka byla zatrzymywana w formie zapasow przez ' + 
CAST(ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + 
Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) AS nvarchar(10)) + ' dni.'

WHEN ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) > 10
THEN 
'Poziom zapasow moze byc zbyt niski. Firma odnawiala swoje zapasy w ciagu roku ' +
CAST(ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2) AS nvarchar(10))
+' razy/a. ' + 'Gotowka byla zatrzymywana w formie zapasow przez ' + 
CAST(ROUND(360 / ROUND(SUM(S.Sprzed_Netto) / ROUND((Stan_Poczatek + Wartosc_Zapasu_Koniec) / 2, 2), 2), 2) AS nvarchar(10)) + ' dni.'
END

FROM @zapasy_poczatek AS P
JOIN #zapasy_Wart AS W
ON P.Rok = W.Rok
LEFT JOIN #sprzedaz AS S
ON P.Rok = S.Rok
GROUP BY P.Rok, Stan_Poczatek, Wartosc_Zapasu_Koniec

DROP TABLE #zapasy
DROP TABLE #zapasy_Wart
DROP TABLE #sprzedaz

/* procedura zwracaja analize stanu zapasow w latach od roku pierwszej dostawy do ostatniego zamknietego roku */
