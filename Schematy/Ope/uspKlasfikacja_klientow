USE Stacja_Paliw

GO


 IF OBJECT_ID('Ope.uspKlasyfikacja_klientow') IS NOT NULL
 DROP PROC Ope.uspKlasyfikacja_klientow;

 --Instukcja sprawdzająca czy istnieje już procedura Ope.Ope.uspKlasyfikacja_klientow jeśli tak to jest likwidowana. Zakładamy, że jeśli istnieje to przez pomyłkę--


 GO

CREATE PROC Ope.uspKlasyfikacja_klientow
 
 AS

WITH  Obr_Zafak_CTE (IdKlienta,Obrot_Z_FV) AS

(SELECT
IdKlienta,
SUM(KwotaNetto)
FROM Ope.Sprzedaz
GROUP BY IdKlienta),

Obr_Niezap_CTE (IdKlienta,Obrot_Niezaplacony) AS

(SELECT 
IdKlienta, 
SUM(KwotaNetto)
FROM Ope.Sprzedaz
WHERE DataZaplaty IS NULL 
GROUP BY IdKlienta),
 

Obr_Przeter_CTE (IdKlienta,Obrot_Przeterminowany) AS

(SELECT
IdKlienta, 
SUM(KwotaNetto)
FROM Ope.Sprzedaz
WHERE DataZaplaty IS NULL 
AND DATEDIFF(d,TerminZaplaty,GETDATE())>0
GROUP BY IdKlienta,DataZaplaty), 

FV_CTE (IdKlienta, FV) AS 

(SELECT
IdKlienta,
NRFV 
FROM Ope.Sprzedaz 
GROUP BY IdKlienta, NRFV),

Ile_FV (IdKlienta, Il_FV) AS

(SELECT 
k.IdKlienta, 
COUNT(FV) 
FROM FV_CTE  as C RIGHT JOIN Ope.Klienci as K ON k.IdKlienta=c.IdKlienta
GROUP BY k.IdKlienta ),

Paliwa_CTE (IdKlienta, Paliwa) AS

(SELECT 
IdKlienta,
IDPaliwa 
FROM Ope.Sprzedaz
GROUP BY IdKlienta, IDPaliwa)


 SELECT
 K.IdKlienta, 
 K.NazwaKlienta, 
 ROUND(SUM(Obrot_Z_FV),2) AS Obrot_Z_FV,
 ROUND(SUM(Obrot_Niezaplacony),2) AS Obrot_Niezaplacony,
  '%_Niezaplacony' = CASE  WHEN  SUM(Obrot_Niezaplacony)=0 OR SUM(Obrot_Niezaplacony) IS NULL  THEN 0 
 WHEN SUM(Obrot_Niezaplacony)>0 THEN ROUND(SUM(Obrot_Niezaplacony)/SUM(Obrot_Z_FV),2) 
 END ,
 ROUND( SUM(Obrot_Przeterminowany),2) AS Obrot_Przeterminowany,
 '%_Przeterminowany' = CASE WHEN SUM(Obrot_Przeterminowany)=0 OR SUM(Obrot_Przeterminowany) IS NULL  THEN 0 
 WHEN SUM(Obrot_Przeterminowany)>0 THEN ROUND(SUM(Obrot_Przeterminowany)/SUM(Obrot_Z_FV),2) 
 END, 
 Il_FV AS Z_Ilu_FV ,
 COUNT(Paliwa) AS Na_Ilu_Paliwach
 
 FROM Ope.Klienci AS K
 LEFT JOIN Obr_Zafak_CTE AS O ON K.IdKlienta=O.IdKlienta 
 LEFT JOIN Obr_Niezap_CTE AS N ON K.IdKlienta=N.IdKlienta
 LEFT JOIN Obr_Przeter_CTE AS P ON K.IdKlienta=P.IdKlienta
 LEFT JOIN Ile_FV AS F ON K.IdKlienta=F.IdKlienta
 LEFT JOIN Paliwa_CTE AS Pa ON K.IdKlienta=Pa.IdKlienta
 
 GROUP BY K.IdKlienta,K.NazwaKlienta,Il_FV ORDER BY  SUM(Obrot_Z_FV)  DESC

 /*Procedura klasyfikujaca klientow wg parametrow takich jak obrot w rozbiciu na przeterminowany i niezaplacony ilosc fv i ilosc kupowanych paliw*/
 
 
