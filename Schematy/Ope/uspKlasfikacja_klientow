USE Stacja_Paliw

GO


 IF OBJECT_ID('Ope.uspKlasyfikacja_klientow') IS NOT NULL
 DROP PROC Ope.uspKlasyfikacja_klientow;

 --Instukcja sprawdzająca czy istnieje już procedura Ope.Ope.uspKlasyfikacja_klientow jeśli tak to jest likwidowana. Zakładamy, że jeśli istnieje to przez pomyłkę--


 GO

CREATE PROC Ope.uspKlasyfikacja_klientow
 
 AS

WITH  Obr_Zafak_CTE (IdKlienta,Obrot_Z_FV) AS 
(
SELECT
K.IdKlienta,
ISNULL(ROUND(SUM(KwotaNetto),2),0) 

FROM Ope.Klienci AS K LEFT JOIN Ope.Sprzedaz AS S ON K.IdKlienta=S.IdKlienta  GROUP BY K.IdKlienta), 

Obr_Niezap_CTE (IdKlienta,Obrot_Niezaplacony) AS 
(
SELECT 
K.IdKlienta,
ROUND(SUM(KwotaNetto),2)

FROM Ope.Klienci AS K LEFT JOIN Ope.Sprzedaz AS S ON K.IdKlienta=S.IdKlienta WHERE DataZaplaty IS NULL 
GROUP BY K.IdKlienta),
 

Obr_Przeter_CTE (IdKlienta,Obrot_Przeterminowany) AS
(
SELECT 
K.IdKlienta,
ROUND(SUM(KwotaNetto),2)

FROM Ope.Klienci AS K LEFT JOIN Ope.Sprzedaz AS S ON K.IdKlienta=S.IdKlienta
WHERE DataZaplaty IS NULL 
AND DATEDIFF(d,TerminZaplaty,GETDATE())>0 GROUP BY K.IdKlienta,DataZaplaty), 

FV_CTE (IdKlienta, FV) AS 
(
SELECT
K.IdKlienta,
NRFV 

FROM Ope.Klienci AS K LEFT JOIN Ope.Sprzedaz AS S ON K.IdKlienta=S.IdKlienta GROUP BY K.IdKlienta,NRFV),

Ile_FV (IdKlienta, Il_FV) AS 
(
SELECT 
k.IdKlienta,
ISNULL(COUNT(FV),0) 

FROM FV_CTE  as C RIGHT JOIN Ope.Klienci as K ON k.IdKlienta=c.IdKlienta
GROUP BY k.IdKlienta ),

Paliwa_CTE (IdKlienta, Paliwa) AS 
(
SELECT
K.IdKlienta,
IDPaliwa 

FROM Ope.Klienci AS K LEFT JOIN Ope.Sprzedaz AS S ON K.IdKlienta=S.IdKlienta  GROUP BY K.IdKlienta,IDPaliwa)


 SELECT 
 K.IdKlienta, 
 K.NazwaKlienta,
 Obrot_Z_FV,
 ISNULL(Obrot_Niezaplacony,0) AS Obrot_Niezaplacony,
 '%_Niezaplacony' = CASE
 WHEN  ISNULL(Obrot_Niezaplacony,0) = 0   THEN 0 
 WHEN SUM(Obrot_Niezaplacony) > 0 THEN ROUND(Obrot_Niezaplacony/Obrot_Z_FV,2) 
 END,
 ISNULL(Obrot_Przeterminowany,0) AS Obrot_Przeterminowany,
 '%_Przeterminowany' = CASE 
 WHEN ISNULL(Obrot_Przeterminowany,0) = 0   THEN 0 
 WHEN SUM(Obrot_Przeterminowany) > 0 THEN ROUND(Obrot_Przeterminowany/Obrot_Z_FV,2) 
 END, 
 Il_FV AS Z_Ilu_FV, 
 ISNULL(COUNT(Paliwa),0) AS Na_Ilu_Paliwach
 
 FROM Ope.Klienci AS K
 LEFT JOIN Obr_Zafak_CTE AS O ON K.IdKlienta=O.IdKlienta 
 LEFT JOIN Obr_Niezap_CTE AS N ON K.IdKlienta=N.IdKlienta
 LEFT JOIN Obr_Przeter_CTE AS P ON K.IdKlienta=P.IdKlienta
 LEFT JOIN Ile_FV AS F ON K.IdKlienta=F.IdKlienta
 LEFT JOIN Paliwa_CTE AS Pa ON K.IdKlienta=Pa.IdKlienta
 
 GROUP BY K.IdKlienta, K.NazwaKlienta, Obrot_Z_FV , Obrot_Niezaplacony, Obrot_Przeterminowany, Il_FV ORDER BY  SUM(Obrot_Z_FV)  DESC
 
 /*Procedura klasyfikujaca klientow wg parametrow takich jak obrot w rozbiciu na przeterminowany i niezaplacony ilosc fv i ilosc kupowanych paliw*/
 
 
