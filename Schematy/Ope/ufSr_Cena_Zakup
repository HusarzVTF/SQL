

USE Stacja_Paliw

GO

IF OBJECT_ID('Ope.ufSr_Cena_Zakup') IS NOT NULL
DROP FUNCTION Ope.ufSr_Cena_Zakup;

GO
CREATE FUNCTION Ope.ufSr_Cena_Zakup(@rok int, @idpa tinyint) 

RETURNS money
WITH SCHEMABINDING  

AS
BEGIN

DECLARE @cena money = ( SELECT Cena_Sr_Zakup FROM (

SELECT YEAR(CzasTransakcji) AS Rok , IDPaliw, SUM(IloscPaliwa) AS IloscPaliwa, SUM(KwotaNetto) AS Wartosc_Net, ROUND(SUM(KwotaNetto) /  SUM(IloscPaliwa) ,2) AS Cena_Sr_Zakup

FROM Ope.Dostawy AS D 

WHERE IDPaliw = @idpa AND YEAR(CzasTransakcji) = @rok  

GROUP BY YEAR(CzasTransakcji)  , IDPaliw ) AS A)

return @cena 

END

/* fukcja liczaca srednia wazona cene zakupu wskazanego paliwa za podany rok */
