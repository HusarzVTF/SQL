USE Stacja_Paliw;

GO

IF OBJECT_ID('Ope.uspZobWiekoNaDzisPrzet') IS NOT NULL
DROP PROC Ope.uspZobWiekoNaDzisPrzet;
 
 --Instukcja sprawdzająca czy istnieje już procedura Ope.uspZobWiekoNaDzisPrzet jeśli tak to jest likwidowana. Zakładamy, że jeśli istnieje to przez pomyłkę--

 GO

 CREATE PROC Ope.uspZobWiekoNaDzisPrzet
 
 AS

 BEGIN
 
SELECT
D.IdDostawcy,
D.NazwaDostawcy,
RodzajPaliwa,SUM(KwotaNetto) AS Zob_Net_30, 
SUM(KwotaBrutto) AS Zob_Br_30 

INTO #Trzydz_Zob
FROM Dostawy AS DS
INNER JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=DS.IDPaliw
LEFT  JOIN Dostawcy AS D ON D.IdDostawcy=DS.IdDostawcy 

GROUP BY D.IdDostawcy,D.NazwaDostawcy,RodzajPaliwa,DataZaplaty,TerminZaplaty
HAVING DataZaplaty IS NULL 
AND DATEDIFF(d,TerminZaplaty,GETDATE())<=30 


SELECT 
D.IdDostawcy,
D.NazwaDostawcy,
RodzajPaliwa,
SUM(KwotaNetto) AS Zob_Net_31_60, 
SUM(KwotaBrutto) AS Zob_Br_31_60

INTO #SzeszDZ_Zob
FROM Dostawy AS DS
INNER JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=DS.IDPaliw
LEFT  JOIN Dostawcy AS D ON D.IdDostawcy=DS.IdDostawcy 

GROUP BY D.IdDostawcy,D.NazwaDostawcy, RodzajPaliwa,DataZaplaty,TerminZaplaty
HAVING DataZaplaty IS NULL  
AND DATEDIFF(d,TerminZaplaty,GETDATE()) BETWEEN 31 AND 60 


SELECT 
D.IdDostawcy,
D.NazwaDostawcy,
RodzajPaliwa,
SUM(KwotaNetto) AS Zob_Net_61_90, 
SUM(KwotaBrutto) AS Zob_Br_61_90

INTO #DZiew_Zob
FROM Dostawy AS DS
INNER JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=DS.IDPaliw
LEFT  JOIN Dostawcy AS D ON D.IdDostawcy=DS.IdDostawcy 

GROUP BY D.IdDostawcy,D.NazwaDostawcy, RodzajPaliwa,DataZaplaty,TerminZaplaty
HAVING DataZaplaty IS NULL  
AND DATEDIFF(d,TerminZaplaty,GETDATE()) BETWEEN 61 AND 90 


SELECT
D.IdDostawcy,
D.NazwaDostawcy,
RodzajPaliwa,
SUM(KwotaNetto) AS Zob_Net_91_120, 
SUM(KwotaBrutto) AS Zob_Br_91_120

INTO #StoDw_Zob
FROM Dostawy AS DS
INNER JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=DS.IDPaliw
LEFT  JOIN Dostawcy AS D ON D.IdDostawcy=DS.IdDostawcy 

GROUP BY D.IdDostawcy,D.NazwaDostawcy, RodzajPaliwa,DataZaplaty,TerminZaplaty
HAVING DataZaplaty IS NULL  
AND DATEDIFF(d,TerminZaplaty,GETDATE()) BETWEEN 91 AND 120 

SELECT 
D.IdDostawcy,
D.NazwaDostawcy,
RodzajPaliwa,SUM(KwotaNetto) AS Zob_Net_120_POW, 
SUM(KwotaBrutto) AS Zob_Br_120_POW

INTO #PoStoDw_Zob
FROM Dostawy AS DS
INNER JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=DS.IDPaliw
LEFT  JOIN Dostawcy AS D ON D.IdDostawcy=DS.IdDostawcy 

GROUP BY D.IdDostawcy,D.NazwaDostawcy, RodzajPaliwa,DataZaplaty,TerminZaplaty
HAVING DataZaplaty IS NULL  
AND DATEDIFF(d,TerminZaplaty,GETDATE())> 120 
 
 
SELECT 
DS.IdDostawcy,
DS.NazwaDostawcy,
T.RodzajPaliwa,SUM(Zob_Net_30) AS Zob_Net_30, 
SUM(Zob_Br_30) AS Zob_Br_30,
SUM(Zob_Net_61_90) AS Zob_Net_61_90, 
SUM(Zob_Br_61_90) AS Zob_Br_61_90,
SUM(Zob_Net_91_120) AS Zob_Net_91_120, 
SUM(Zob_Br_91_120) AS Zob_Br_91_120,
SUM(Zob_Net_120_POW) AS Zob_Net_120_POW, 
SUM(Zob_Br_120_POW) AS Zob_Br_120_POW

FROM Dostawcy AS DS
LEFT  JOIN #Trzydz_Zob AS T ON DS.IdDostawcy = T.IdDostawcy
LEFT  JOIN #SzeszDZ_Zob AS Sz ON DS.IdDostawcy = Sz.IdDostawcy
LEFT JOIN #DZiew_Zob AS Dz ON DS.IdDostawcy = Dz.IdDostawcy
LEFT JOIN #StoDw_Zob AS St ON DS.IdDostawcy = St.IdDostawcy
LEFT JOIN #PoStoDw_Zob AS Ps ON DS.IdDostawcy = Ps.IdDostawcy

GROUP BY DS.IdDostawcy,DS.NazwaDostawcy,T.RodzajPaliwa ORDER BY DS.IdDostawcy


DROP TABLE #Trzydz_Zob
DROP TABLE #SzeszDZ_Zob
DROP TABLE #DZiew_Zob 
DROP TABLE #StoDw_Zob
DROP TABLE #PoStoDw_Zob 



 END;
 

 --Procedura pokazująca wiekowanie zobowiązań przeterminowanych na dzien dzisiejszy (kazdy w ktorym jest wykonana procedura)--
 
 
 
 
 
 
 
 
