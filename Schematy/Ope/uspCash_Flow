

USE Stacja_Paliw

GO

IF OBJECT_ID('Ope.uspCashflow') IS NOT NULL
DROP PROC Ope.uspCashflow;

--Instrukcja sprawdzająca czy procedura uspCashflow już istnieje jeśli tak to jest likwidowana zakładamy, że jeśli istniała to przez pomyłkę--

GO

CREATE PROC Ope.uspCashflow (@od date , @do date)

AS 

IF @od IS  NULL OR @do IS  NULL OR @od>@do 


THROW 701005, 
'Nie podano zakresu dat dla, których ma byc policzony koszt staly lub jedna z dat wprowadzono niepoprawnie tudziez data od jest wieksza niz do', 1;



DECLARE @CashFlow table (ID smallint PRIMARY KEY IDENTITY,Cash varchar(7) , Realny real, Prognoza real);

INSERT INTO @CashFlow (Cash) VALUES ('INCOME'), ('OUTCOME'),('FLOW');

UPDATE @CashFlow SET Realny = (SELECT ISNULL(SUM(KwotaNetto),0) FROM Sprzedaz
WHERE TerminZaplaty BETWEEN @od AND @do AND DataZaplaty IS NOT NULL)  WHERE Cash='INCOME';

UPDATE @CashFlow SET Prognoza = (SELECT ISNULL(SUM(KwotaNetto),0) FROM Sprzedaz
WHERE TerminZaplaty BETWEEN @od AND @do AND DataZaplaty IS  NULL)  WHERE Cash='INCOME';

UPDATE @CashFlow SET Realny = (SELECT ISNULL(SUM(KwotaNetto),0) + Ope.LiczWyn(@od,@do) FROM Dostawy 
WHERE TerminZaplaty BETWEEN @od AND @do AND DataZaplaty IS NOT NULL)  *-1 
WHERE Cash='OUTCOME';

UPDATE @CashFlow SET Prognoza = (SELECT ISNULL(SUM(KwotaNetto),0) + Ope.LiczWyn(@od,@do) FROM Dostawy 
WHERE TerminZaplaty BETWEEN @od AND @do AND DataZaplaty IS NULL)  *-1 
WHERE Cash='OUTCOME';



DECLARE @FlowOkrIInc real = (SELECT Realny FROM @CashFlow WHERE Cash='INCOME')

DECLARE @FlowOkrIOut real = (SELECT Realny FROM @CashFlow WHERE Cash='OUTCOME')

DECLARE @FlowOkr2IInc real = (SELECT Prognoza FROM @CashFlow WHERE Cash='INCOME')

DECLARE @FlowOkr2IOut real = (SELECT Prognoza FROM @CashFlow WHERE Cash='OUTCOME')


UPDATE @CashFlow SET Realny=@FlowOkrIInc + @FlowokrIOut
WHERE Cash='FLOW';

UPDATE @CashFlow SET Prognoza=@FlowOkr2IInc + @Flowokr2IOut
WHERE Cash='FLOW'; 


SELECT*FROM @CashFlow ORDER BY  ID;



--Procedura zwracająca Cash flow w podziale na okres już zakonczony i prognoze na przyszly--





