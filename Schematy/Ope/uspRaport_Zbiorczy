


USE Stacja_Paliw
GO

IF OBJECT_ID('Ope.uspRaport_Zbiorczy') IS NOT NULL
DROP PROC Ope.uspRaport_Zbiorczy

--Instukcja sprawdzająca czy istnieje już procedura Ope.uspRaport_Zbiorczy jeśli tak to jest likwidowana. Zakładamy, że jeśli istnieje to przez pomyłkę--

GO

CREATE PROC Ope.uspRaport_Zbiorczy AS

WITH 
 
Zakup_CTE (IDPaliwa, Rok, Kupiona_Ilosc, Zakup_N) AS

(SELECT

IDPaliw,
YEAR(CzasTransakcji),
ROUND(SUM(IloscPaliwa),2),
ROUND(SUM(KwotaNetto),2)

FROM Ope.Dostawy
GROUP BY IDPaliw, YEAR(CzasTransakcji)),

Sprzedaz_CTE (IDPaliwa, Rok, Sprzedana_Ilosc, Sprzedaz_N) AS

(SELECT

IDPaliwa,
YEAR(CzasTransakcji),
ROUND(SUM(IloscPaliwa),2),
ROUND(SUM(KwotaNetto),2)

FROM Ope.Sprzedaz
GROUP BY IDPaliwa, YEAR(CzasTransakcji))

 
SELECT

C_Z.Rok,
Z.RodzajPaliwa,
JM,
ISNULL(Kupiona_Ilosc,0) AS Kupiona_Ilosc,
SUM(ISNULL(Kupiona_Ilosc,0)) OVER (ORDER BY C_Z.Rok,Z.RodzajPaliwa) AS Kupiona_ilo_Nar,
ISNULL(Zakup_N,0) AS Zakup_N,
SUM(ISNULL(Zakup_N,0)) OVER (ORDER BY C_Z.Rok,Z.RodzajPaliwa) AS Wartosc_Zakupow_Nar,

'Cena_Zakupu_Srednia' = CASE
WHEN ISNULL(Kupiona_Ilosc,0) = 0 THEN 0
ELSE ROUND(ISNULL(Zakup_N,0) / ISNULL(Kupiona_Ilosc,0),2) END,

ISNULL(Sprzedana_Ilosc,0) AS Sprzedana_Ilosc,
SUM(ISNULL(Sprzedana_Ilosc,0)) OVER (ORDER BY C_Z.Rok,Z.RodzajPaliwa) AS Sprzedana_ilo_Nar,
ISNULL(Sprzedaz_N,0) AS Sprzedaz_N,
SUM(ISNULL(Sprzedaz_N,0)) OVER (ORDER BY C_Z.Rok,Z.RodzajPaliwa) AS Sprzedaz_N_Nar,

'Cena_Sprzedazy_Srednia' = CASE
WHEN ISNULL(Sprzedana_Ilosc,0) = 0 THEN 0
ELSE
ROUND(ISNULL(Sprzedaz_N,0) / ISNULL(Sprzedana_Ilosc,0),2)  
END,

'Marza_na_Jednostke_miary' = CASE WHEN ISNULL(Sprzedana_Ilosc,0) = 0 THEN 0
WHEN ISNULL(Kupiona_Ilosc,0) = 0 THEN 0
ELSE
ROUND(ISNULL(Sprzedaz_N,0) / ISNULL(Sprzedana_Ilosc,0) - ISNULL(Zakup_N,0) / ISNULL(Kupiona_Ilosc,0),2)
END,

'M%_na_Jednostke_miary' = CASE WHEN ISNULL(Sprzedana_Ilosc,0) = 0 THEN 0
WHEN ISNULL(Kupiona_Ilosc,0) = 0 THEN 0
ELSE
ROUND((ISNULL(Sprzedaz_N,0) / ISNULL(Sprzedana_Ilosc,0) - ISNULL(Zakup_N,0) / ISNULL(Kupiona_Ilosc,0)) / (ISNULL(Sprzedaz_N,0) / ISNULL(Sprzedana_Ilosc,0)),2)
END 

FROM Ope.Zbiorniki AS Z 
LEFT JOIN Zakup_CTE  AS C_Z ON Z.IDPaliwa=C_Z.IDPaliwa   
LEFT JOIN Sprzedaz_CTE AS S ON S.Rok=C_Z.Rok AND Z.IDPaliwa=S.IDPaliwa
GROUP BY C_Z.Rok, S.Rok, Z.IDPaliwa, JM, Kupiona_Ilosc, Zakup_N, Z.RodzajPaliwa, Sprzedana_Ilosc, Sprzedaz_N

/*Raport podsumowujacy dzialalnosc stacji na przestrzeni lat*/





