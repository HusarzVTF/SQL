

USE Stacja_Paliw
GO


ALTER PROC Ope.uspZrobWynik (@czasOD date , @czasDO date  , @typ varchar(8) ) AS

IF @typ NOT IN('prognoza','realny')

BEGIN
PRINT 'Wpisano nieprawidlowy typ, nalezy wpisac prognoza lub realny '
END;


DECLARE @dni int=(DATEDIFF(d,@czasOD, @czasDO))




IF @typ='prognoza'

BEGIN

UPDATE Ope.WynikOpe SET Kwota=ISNULL((SELECT SUM(KwotaNetto) FROM Ope.Sprzedaz AS S 
INNER JOIN Czas.Kalendarz AS K ON S.ID_Dat=K.ID WHERE TerminZaplaty BETWEEN @czasOD AND @czasDO),0)
WHERE Kategoria='Przychody';

UPDATE Ope.WynikOpe SET Kwota=ISNULL((SELECT SUM(KwotaNetto) FROM Ope.Dostawy  AS D 
INNER JOIN Czas.Kalendarz AS K ON D.ID_Dat=K.ID  WHERE TerminZaplaty BETWEEN @czasOD AND @czasDO),0)
WHERE Kategoria='WydPaliwa';

UPDATE Ope.WynikOpe SET Kwota=Ope.LiczWyn(@czasOD,@czasDO)
WHERE Kategoria='WydWyn';

END;



IF  @typ='realny'

BEGIN

UPDATE Ope.WynikOpe SET Kwota=ISNULL((SELECT SUM(KwotaNetto) FROM Ope.Sprzedaz AS S 
INNER JOIN Czas.Kalendarz AS K ON S.ID_Dat=K.ID WHERE DataZaplaty BETWEEN @czasOD AND @czasDO),0)
WHERE Kategoria='Przychody';

UPDATE Ope.WynikOpe SET Kwota=ISNULL((SELECT SUM(KwotaNetto) FROM Ope.Dostawy  AS D 
INNER JOIN Czas.Kalendarz AS K ON D.ID_Dat=K.ID  WHERE DataZaplaty BETWEEN @czasOD AND @czasDO),0)
WHERE Kategoria='WydPaliwa';


UPDATE Ope.WynikOpe SET Kwota=Ope.LiczWyn(@czasOD,@czasDO)
WHERE Kategoria='WydWyn';


END;


/* Procedura wypełniająca tabelę z uproszczonym wynikiem operacyjnym - danymi za wskazany okres czasu.
W poprzedniej wersji wydatki zwiazane z wynagrodzeniem pracownikow netto nie były w pelni poprawnie naliczane.
Została napisana funkcja na liczenie wynagrodzen w wskazanym okresie i m.in tu zostala wykorzystana */


