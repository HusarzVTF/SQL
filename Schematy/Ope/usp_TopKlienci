USE Stacja_Paliw;

GO

IF OBJECT_ID('Ope.uspTOPKlienci') IS NOT NULL
DROP PROC Ope.uspTOPKlienci;

--Sprawdzenie czy istnieje procedura uspTOPKlienci. Jeśli tak to jest likwidowana, zakładamy że jeśli  istniała to została utworzona przez pomyłkę--

GO

CREATE PROC Ope.uspTOPKlienci AS

BEGIN

SELECT 
K.IdKlienta,
K.NazwaKlienta,  
ISNULL(Z.RodzajPaliwa,'Brak') AS RodzajPaliwa,
ISNULL(Z.JM,'Brak') AS JM,
ISNULL(ROUND(SUM(IloscPaliwa),2),0) AS IloscPaliwa,
ISNULL(ROUND(SUM(KwotaNetto),2),0) AS WartoscNettoPaliwa,
ISNULL(ROUND(SUM(KwotaBrutto),2),0) AS WartoscBruttoPaliwa,  
ISNULL(ROUND(SUM(KwotaBrutto)-SUM(KwotaNetto),2),0) AS  Podatek,
Sr_Cen_Sprz_Netto = CASE 
WHEN SUM(IloscPaliwa)=0 THEN 0
ELSE
ISNULL(ROUND(SUM(KwotaNetto)/SUM(IloscPaliwa),2),0) END , 
Sr_Cen_Sprz_Brutto =  CASE
WHEN SUM(IloscPaliwa)=0 THEN 0
ELSE 
ISNULL(ROUND(SUM(KwotaBrutto)/SUM(IloscPaliwa),2),0) END  

FROM Ope.Sprzedaz AS S RIGHT JOIN Ope.Klienci AS K ON K.IdKlienta=S.IdKlienta  
LEFT JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=S.IDPaliwa

GROUP BY K.IdKlienta, K.NazwaKlienta, Z.JM, Z.RodzajPaliwa ORDER BY K.IdKlienta, Z.RodzajPaliwa  ASC

END;


--Procedura pokazująca zestawienie prezentujące klientów posortowanych od największego do najmniejszego wg ilości sprzedanego paliwa.--


