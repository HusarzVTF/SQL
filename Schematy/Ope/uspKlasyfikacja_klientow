USE Stacja_Paliw

GO


 IF OBJECT_ID('Ope.uspKlasyfikacja_klientow') IS NOT NULL
 DROP PROC Ope.uspKlasyfikacja_klientow;

 --Instukcja sprawdzająca czy istnieje już procedura Ope.Ope.uspKlasyfikacja_klientow jeśli tak to jest likwidowana. Zakładamy, że jeśli istnieje to przez pomyłkę--


 GO

CREATE PROC Ope.uspKlasyfikacja_klientow
 
 AS

WITH  Obr_Zafak_CTE (IdKlienta, Obrot_Z_FV) AS 
 (SELECT IdKlienta, ROUND(SUM(KwotaNetto), 2) 
  FROM Ope.Sprzedaz 
  GROUP BY IdKlienta),

Obr_Niezap_CTE (IdKlienta, Obrot_Niezaplacony) AS 
 (SELECT IdKlienta, ROUND(SUM(KwotaNetto), 2) 
  FROM Ope.Sprzedaz 
  WHERE DataZaplaty IS NULL 
  GROUP BY IdKlienta),
 

Obr_Przeter_CTE (IdKlienta, Obrot_Przeterminowany) AS 
 (SELECT IdKlienta, ROUND(SUM(KwotaNetto), 2) 
  FROM Ope.Sprzedaz 
  WHERE DataZaplaty IS NULL AND DATEDIFF(d, TerminZaplaty, GETDATE()) > 0 
  GROUP BY IdKlienta, DataZaplaty), 



Ile_FV_Paliw (IdKlienta, Il_FV, IL_Paliw) AS 
 (SELECT K.IdKlienta, COUNT(DISTINCT NRFV), COUNT(DISTINCT IDPaliwa) 
  FROM Ope.Sprzedaz AS S 
  RIGHT JOIN Ope.Klienci AS K ON k.IdKlienta = S.IdKlienta
  GROUP BY K.IdKlienta)



 SELECT

  K.IdKlienta, K.NazwaKlienta, ISNULL(Obrot_Z_FV, 0) AS Obrot_Z_FV, ISNULL(Obrot_Niezaplacony, 0) AS Obrot_Niezaplacony,
 '%_Niezaplacony' = 
    CASE  WHEN  ISNULL(Obrot_Z_FV, 0) = 0  OR ISNULL(Obrot_Niezaplacony, 0) = 0 
    THEN FORMAT(0, 'P') 
    ELSE FORMAT(ROUND(Obrot_Niezaplacony / Obrot_Z_FV, 2), 'P') 
    END,
 ISNULL(Obrot_Przeterminowany,0) AS Obrot_Przeterminowany,
 '%_Przeterminowany' = 
    CASE WHEN ISNULL(Obrot_Przeterminowany, 0) = 0 OR ISNULL(Obrot_Z_FV,0) = 0  
    THEN FORMAT(0,'P') 
    ELSE FORMAT(ROUND(Obrot_Przeterminowany / Obrot_Z_FV, 2), 'P')
    END, 
 Il_FV AS Z_Ilu_FV , IL_Paliw AS Na_Ilu_Paliwach,
 'Sr_Kwota_FV' = 
    CASE WHEN Il_FV = 0 OR ISNULL(Obrot_Z_FV, 0) = 0 
    THEN 0  
    ELSE ROUND(Obrot_Z_FV / Il_FV, 2) END,  
 'Sr_Kwota_Paliwo' = 
    CASE WHEN IL_Paliw = 0 OR ISNULL(Obrot_Z_FV, 0) = 0 
    THEN 0 
    ELSE ROUND(Obrot_Z_FV / IL_Paliw, 2) END,
 'Sr_FV_Paliwo' = 
    CASE WHEN IL_Paliw = 0 OR Il_FV = 0 
    THEN 0 
    ELSE ROUND(Il_FV / IL_Paliw, 2)   END, 
 
 FROM Ope.Klienci AS K
 LEFT JOIN Obr_Zafak_CTE AS O ON K.IdKlienta = O.IdKlienta 
 LEFT JOIN Obr_Niezap_CTE AS N ON K.IdKlienta = N.IdKlienta
 LEFT JOIN Obr_Przeter_CTE AS P ON K.IdKlienta = P.IdKlienta
 LEFT JOIN Ile_FV_Paliw AS F ON K.IdKlienta = F.IdKlienta


 ORDER BY  ISNULL(Obrot_Z_FV, 0) DESC

 
 /* Procedura klasyfikujaca klientow wg parametrow takich jak obrot w rozbiciu na przeterminowany i niezaplacony ilosc fv i ilosc kupowanych paliw */
 
 
