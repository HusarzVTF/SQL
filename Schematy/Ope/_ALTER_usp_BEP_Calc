

USE Stacja_Paliw

GO

ALTER PROC Ope.uspKalk_BEP (@od date, @do date)

AS

BEGIN

DECLARE @ks real=ROUND(Ope.LiczWyn(@od,@do),2)

SELECT

C.IDPALIW,
Z.RodzajPaliwa,
Z.JM ,
CenaJedn,
@ks AS Licznik,
ROUND(CenaJedn-ROUND(SUM(KwotaNetto)/SUM(IloscPaliwa),2),2) AS Mianownik,
ROUND(@ks/(CenaJedn-ROUND(SUM(KwotaNetto)/SUM(IloscPaliwa),2)),2) AS BEP_Ilosciowy,
Z.StanZbiornika,
ROUND(Z.StanZbiornika - ROUND(@ks/(CenaJedn-ROUND(SUM(KwotaNetto)/SUM(IloscPaliwa),2)),2),2) AS Zapas,
ROUND((@ks/(CenaJedn-ROUND(SUM(KwotaNetto)/SUM(IloscPaliwa),2))*CenaJedn),2) AS BEP_Wartosciowy

INTO #kalk
FROM Stacja_Paliw.Ope.CenyPa AS C
INNER JOIN Stacja_Paliw.Ope.Zbiorniki AS Z ON Z.IDPaliwa=C.IDPALIW
INNER JOIN Stacja_Paliw.Ope.Dostawy AS D ON D.IDPaliw=C.IDPALIW
GROUP BY C.IDPALIW,Z.RodzajPaliwa,Z.JM ,CenaJedn,Z.StanZbiornika
ORDER BY IDPALIW

SELECT*FROM #kalk ORDER BY IDPALIW

IF EXISTS (SELECT Zapas FROM #kalk WHERE Zapas<0 )

BEGIN

SELECT RodzajPaliwa,JM,Zapas*-1 AS Dokupic FROM #kalk WHERE Zapas<0 

PRINT 

'Ilosc paliwa dostepnego w sprzedazy jest zbyt mala do przekroczenia break even point. 
Trzeba zamowic dodatkowa ilosc paliwa w wysokosci wskazanej w tabelce albo zamknac dzialanosc 
jesli nie masz wiecej srodkow finansowych, bo dzialanosc przy dostepnych zasobach jest nieoplacalna.'

END

IF EXISTS (SELECT Zapas FROM #kalk WHERE Zapas=0 )

BEGIN

SELECT RodzajPaliwa,JM,Zapas FROM #kalk WHERE Zapas=0 

PRINT 'Ilosc paliwa dostepnego w sprzedazy jest na styk break even point.'

END

DROP TABLE #kalk

END

/*
Ze wzgledu na zaokraglenia do dwoch miejsc po przecinku wyniki moga odchylac sie o grosze.
W poprzedniej wersji ta procedura filtrowala dane do wyliczen cen i BEP-u co moglo prowadzic 
do odchylen od cen realnych. Wynika to z tego, ze mechanizm wyliczania ceny sprzedazy jest ruchomy 
i uzalezniony od ceny zakupu i ustalonego poziomu marzy. Kazda nowa dostawa zmienia cene sprzedazy 
a przez to i BEP. Dlatego BEP musi byc liczony po aktualnych cenach uwzgledniajacych wszystkie dostawy.
Nie ma czegos takiego jak BEP na dany moment mozna go wyliczyc, ale jest on nieaktualny, bo opiera sie na
starych nieobowiazujacych cenach sprzedazy.
*/








