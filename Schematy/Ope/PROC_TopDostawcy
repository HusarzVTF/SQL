USE Stacja_Paliw;

GO

IF OBJECT_ID('Ope.uspTOPDostawcy') IS NOT NULL
DROP PROC Ope.uspTOPDostawcy;

--Sprawdzenie czy istnieje procedura uspTopDostawcy. Jeśli tak to likwiduje ją, zakładamy że jeśli już istniała to została stworzona przez pomyłkę.--

GO

CREATE PROC Ope.uspTOPDostawcy AS

BEGIN

SELECT
Dst.IdDostawcy,
Dst.NazwaDostawcy,
ISNULL(Z.RodzajPaliwa,'Brak') AS RodzajPaliwa,
ISNULL(Z.JM,'Brak') AS JM,
ISNULL(ROUND(SUM(IloscPaliwa),2),0) AS IloscPaliwa,  
ISNULL(Round(SUM(KwotaNetto),2),0) AS WartoscNettoPaliwa,
ISNULL(ROUND(SUM(KwotaBrutto),2),0) AS WartoscBruttoPaliwa, 
ISNULL(ROUND(SUM(KwotaBrutto)-SUM(KwotaNetto),2),0) AS  Podatek,
Sr_Cen_Zak_Netto = CASE
WHEN SUM(IloscPaliwa)=0 THEN 0
ELSE ISNULL(ROUND(SUM(KwotaNetto)/SUM(IloscPaliwa),2),0)  
END,
Sr_Cen_Zak_Brutto = CASE
WHEN SUM(IloscPaliwa)=0 THEN 0
ELSE ISNULL(ROUND(SUM(KwotaBrutto)/SUM(IloscPaliwa),2),0) 
END 

FROM Ope.Dostawy  AS D
RIGHT JOIN Ope.Dostawcy  AS Dst ON DST.IDDostawcy=D.IdDostawcy LEFT JOIN Ope.Zbiorniki AS Z ON Z.IDPaliwa=D.IDPaliw

GROUP BY  Dst.IdDostawcy, Dst.NazwaDostawcy, Z.RodzajPaliwa, Z.JM ORDER BY Dst.IdDostawcy, Z.RodzajPaliwa ASC;

END;

--Procedura pokazująca zestawienie prezentujące dostawców posortowanych od największego do najmniejszego wg ilości zakupionego od nich paliwa.--


