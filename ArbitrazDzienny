 /*
Czym jest arbitraż: Polega na wykorzystaniu rozbieżności pomiędzy ceną jednego dobra względem innego w taki sposób, że możliwa
jest wymiana danego dobra na inne i spowrotem na dobro z którego rozpoczęła się wymiana notując przy tym zysk. 
Zjawisko w poniższym przykładzie dotyczy rynku walutowego, ale może zaistnieć na rynku wszelkich innych dóbr.

Wersja MS SQL 2014
Pominięto tworzenie schematu. System sam utworzy obiekty w domyślnym schemacie dbo. 
*/
 
 IF OBJECT_ID('Arbitraz') IS NOT NULL
 DROP DATABASE Arbitraz;

--Sprawdza czy istnieje baza danych Arbitraż. Jeśli tak to likwiduje ją jeśli istnieje to zakładamy, że została stworzona przez pomyłkę-- 

CREATE DATABASE Arbitraz;

--Towrzenie bazy arbitraz--

GO

USE Arbitraz;
 
GO 
--Wskazanie na wykorzystanie bazy Arbitraż do utworzenia poniższych obiektów--

IF OBJECT_ID('Kwotowania') IS NOT NULL
DROP TABLE Kwotowania;

--Sprawdza czy istnieje tabela kwotowania jeśli tak to likwiduje ją. Jeśli istnieje to zakładamy, że została stworzona przez pomyłkę--

 CREATE TABLE Kwotowania(ID int  IDENTITY(1,1), PierwszaWaluta char(3) ,DrugaWaluta char(3) , 
 Kurs numeric(10,5) not null, Data date  PRIMARY KEY(PierwszaWaluta,DrugaWaluta ,Data));

 /*
 Tworzenie tabeli Kwotowania.Kurs walutowy do max pięciu miejsc przed przecinkiem i pięciu po przecinku. 
 Klucz główny został tak utworzony, żeby wyeliminować wstawienie duplikatu dla danej pary walutowej w konkretnym dniu. 
 Zgodnie z założeniem jednego kursu danej pary walutowej w danym dniu.
 */

 INSERT INTO Kwotowania (PierwszaWaluta,DrugaWaluta, Kurs, Data) VALUES ('EUR','USD',1.42800,'1912-10-25'), 
 ('EUR','PLN',4.00000,'1912-10-25'), ('USD','EUR',0.70000,'1912-10-25'), ('USD','PLN',3.00000,'1912-10-25'), 
 ('PLN','EUR',0.25000,'1912-10-25'), ('PLN','USD',0.33000,'1912-10-25');
 
 --Wstawienie kursów do tabeli kwotowania. Kursy zostały zmyślone zbieżność z danymi rzeczywistymi jest przypadkowa--

IF OBJECT_ID('uspWykonajArbitraz') IS NOT NULL
DROP PROC uspWykonajArbitraz;

 GO

 CREATE PROC uspWykonajArbitraz (@StartWaluta char(3), @1PosrWaluta char(3), @2PosrWaluta char(3),@Data date)
 
 /*
 Defniowanie czterech parametrów dla których procedura sprawdzi istnienie arbitrażu walutowego. 
 Parametry  to waluta z której rozpoczynamy arbitraż, dwie waluty, które są kolejno wymieniane w procesie arbitrażu i data.
 */

 AS
 DECLARE  @start numeric(10,5)= (SELECT Kurs FROM trening.dbo.Kwotowania WHERE @Data=Data 
 AND @StartWaluta=PierwszaWaluta AND @1PosrWaluta=DrugaWaluta)
 
 --Deklarowanie zmiennej, którą jest pierwsza para walutowa na jaką dokonujemy wymiany.--
 
 DECLARE  @przejscie1 numeric(10,5)=(SELECT Kurs FROM trening.dbo.Kwotowania WHERE @Data=Data
 AND @1PosrWaluta=PierwszaWaluta AND @2PosrWaluta=DrugaWaluta)
 
 --Deklarowanie zmiennej, którą jest druga para walutowa na którą dokonujemy wymiany z pierwszej.--

 DECLARE  @przejscie2 numeric(10,5)=(SELECT Kurs FROM trening.dbo.Kwotowania WHERE @Data=Data 
 AND @2PosrWaluta=PierwszaWaluta AND @1PosrWaluta=DrugaWaluta)
 
 --Deklarowanie zmiennej, którą jest trzecia para walutowa na którą dokonujemy wymiany z drugiej.--

 DECLARE  @finalprzejscie numeric(10,5)=(SELECT Kurs FROM trening.dbo.Kwotowania WHERE @Data=Data 
 AND @2PosrWaluta=PierwszaWaluta AND @StartWaluta=DrugaWaluta)
 
 --Deklarowanie zmiennej, którą jest ostatnia para walutowa na jaką dokonujemy wymiany z trzeciej.--

 DECLARE  @podzielnik numeric(10,5)=@start/@przejscie2

 /*
 Deklarowanie zmiennej, którą jest kurs pierwszej pary walutowej na jaką dokonujemy wymiany 
 podzielony przez trzecią parę walutową na którą dokonujemy wymiany
 */


 DECLARE @arbitrazowyZysk numeric(10,5)=@podzielnik*@finalprzejscie 

--Deklarowanie zmiennej, którą jest ostatnia para walutowa pomnożona przez zmienną @podzielnik--
 
 DECLARE @Zysk numeric(10,5)=@arbitrazowyZysk-1

 --Deklarowanie zmiennej, która sprawdza czy transakcja arbitrażowa dla wprowadzonych parametrów da zysk---

 IF @Zysk>0.00000 BEGIN PRINT N'Arbitraz mozliwy zysk wynosi' +' '+ CAST(@Zysk as nvarchar(10)) END 
 ELSE PRINT 'Arbitraz nie jest mozliwy strata wynosi'+ ' '+CAST(@Zysk as nvarchar(10));
 
 --Komunikat zwrócony w wyniku procedury, który informuje o możliwym zysku arbitrażowym lub jego braku--
